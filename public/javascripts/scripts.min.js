"use strict";var template={hopTemplate:function(t){var e="<b>Hop "+t.hop+"</b><br>IP: "+t.ip+"<br>RTT: "+t.rtt1+"<br>City: "+t.city+"<br>Country: "+t.country+"<br>Latitude: "+t.latitude+"<br>Longitude: "+t.longitude+"<br>";return e}},Mapping=function(){this.markers=[],this.polylinePoints=[]};Mapping.prototype.initialize=function(){this.map=L.map("map",{center:[51.505,-.09],zoom:13,minZoom:2}),L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',maxZoom:18}).addTo(this.map)},Mapping.prototype.getMap=function(){return this.map},Mapping.prototype.removeLayers=function(){this.map.eachLayer(function(t){t._url||this.map.removeLayer(t)}.bind(this))},Mapping.prototype.addMarker=function(t){var e=L.marker([t.latitude,t.longitude],{icon:L.AwesomeMarkers.icon({text:t.hop})}).addTo(this.map);e.bindPopup(template.hopTemplate(t)).openPopup(),this.markers.push(e)},Mapping.prototype.getMarkers=function(){return this.markers},Mapping.prototype.addPolylines=function(t){if(this.polylinePoints.push(new L.LatLng(t.latitude,t.longitude)),this.polylinePoints.length>1){var e=this.polylinePoints[this.polylinePoints.length-1],o=this.polylinePoints[this.polylinePoints.length-2];new L.Polyline([e,o]).addTo(this.map)}var n=new L.Polyline(this.polylinePoints);this.map.fitBounds(n.getBounds())},Mapping.prototype.clearData=function(){this.markers.length=0,this.polylinePoints.length=0},Mapping.prototype.startProgressIndicator=function(){this.map.spin(!0)},Mapping.prototype.stopProgressIndicator=function(){this.map.spin(!1)};var Sidebar=function(t){this.scrollCounter=0,this.sidebar=null,this.markers=t};Sidebar.prototype.initialize=function(t){this.sidebar=L.control.sidebar("sidebar",{position:"right"}).addTo(t)},Sidebar.prototype.open=function(){this.sidebar.open("hopsPane")},Sidebar.prototype.tableTemplate=function(t){return"<tr><td>"+template.hopTemplate(t)+"</td></tr>"},Sidebar.prototype.appendTable=function(t){$("#hopsTable").append(this.tableTemplate(t)),$(".sidebar-content").animate({scrollTop:this.scrollCounter+=500},1e3);var e=this.markers,o=$("#hopsTable tr");o.unbind("click"),o.click(function(){var t=$(this).html(),o=e.findIndex(function(e){return t.includes(e._popup._content)});o!==-1&&e[o].openPopup()})},Sidebar.prototype.clearTable=function(){this.scrollCounter=0,$("#hopsTable").empty()},$(document).ready(function(){var t=new Mapping;t.initialize();var e=new Sidebar(t.getMarkers());e.initialize(t.getMap()),$("#submit").click(function(){var o=$("#domainName").val();return validator.isFQDN(o+"")||validator.isIP(o+"")?(t.clearData(),t.removeLayers(),e.clearTable(),void $.post("/trace",{domainName:o},function(o,n){if("success"===n){var i=null,r=[],a=io("/"+o.guid);a.on("connect",function(){console.log("connected to server"),t.startProgressIndicator(),e.open()}).on("connect_error",function(){console.log("connection error, disconnecting socket"),a.disconnect(),t.stopProgressIndicator()}).on("destination",function(t){i=t}).on("data",function(o){console.log(o),"*"!==o.latitude&&"*"!==o.longitude&&(r.push(o),t.addMarker(o),t.addPolylines(o)),e.appendTable(o)}).on("close",function(){r[r.length-1].ip!==i.ip&&(t.addMarker(i),t.addPolylines(i),e.appendTable(i)),console.log("disconnecting from server"),a.disconnect(),t.stopProgressIndicator(),console.log("close")}).on("terminated",function(){console.log("disconnecting from server"),a.disconnect(),t.stopProgressIndicator(),console.log("terminated")})}})):(console.log("invalid input: "+o),toastr.options={closeButton:!0,debug:!1,newestOnTop:!1,progressBar:!0,positionClass:"toast-top-right",preventDuplicates:!0,onclick:null,showDuration:300,hideDuration:1e3,timeOut:2e3,extendedTimeOut:1e3,showEasing:"swing",hideEasing:"linear",showMethod:"fadeIn",hideMethod:"fadeOut"},void toastr.error("Input a domain name or ip address"))}),$('[data-toggle="popover"]').popover(),$("#domainName").keypress(function(t){13===t.keyCode&&$("#submit").click()})});